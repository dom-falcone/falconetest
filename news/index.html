<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>–ù–æ–≤–æ—Å—Ç–∏ - Dom Falcone</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css?v=3">
    <link rel="icon" href="../assets/images/Falcone-circle.png" type="image/png">
    
    <style>
        :root {
            --color-primary: #ff1744;
            --color-bg: #0a0a0a;
            --color-surface: #1a1a1a;
            --transition: all 0.3s ease;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .user-profile-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 0.3rem 1rem 0.3rem 0.3rem;
            background: rgba(255, 23, 68, 0.1);
            border: 1px solid rgba(255, 23, 68, 0.3);
            border-radius: 30px;
            position: relative;
            text-decoration: none;
            transition: var(--transition);
            cursor: pointer;
        }

        .user-profile-info:hover {
            background: rgba(255, 23, 68, 0.2);
            border-color: rgba(255, 23, 68, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 23, 68, 0.3);
        }

        .user-profile-info::before {
            content: '';
            position: absolute;
            left: 8px;
            bottom: 8px;
            width: 10px;
            height: 10px;
            background-color: #00e676;
            border-radius: 50%;
            border: 2px solid var(--color-bg);
            box-shadow: 0 0 10px #00e676, 0 0 20px rgba(0, 230, 118, 0.8);
            animation: pulse-online 2s infinite;
            z-index: 10;
        }

        @keyframes pulse-online {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        .header-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--color-primary);
            position: relative;
        }

        .user-details {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .user-display-name {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            line-height: 1;
        }

        .user-points-badge {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            color: var(--color-primary);
        }

        .admin-create-btn {
    position: fixed;
    bottom: 30px;
    left: 30px; /* –ò–∑–º–µ–Ω–∏–ª–∏ —Å right –Ω–∞ left */
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, var(--color-primary), #ff4569);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(255, 23, 68, 0.4);
    transition: var(--transition);
    z-index: 100;
    border: none;
}

        .admin-create-btn:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 30px rgba(255, 23, 68, 0.6);
        }

        .admin-create-btn::before,
        .admin-create-btn::after {
            content: '';
            position: absolute;
            background: white;
        }

        .admin-create-btn::before {
            width: 24px;
            height: 3px;
        }

        .admin-create-btn::after {
            width: 3px;
            height: 24px;
        }

        .create-news-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    z-index: 1000;
    overflow-y: auto;
    padding: 2rem 1rem; /* –ò–∑–º–µ–Ω–∏–ª–∏ padding */
}

.create-news-modal.active {
    display: flex;
    align-items: flex-start; /* –ò–∑–º–µ–Ω–∏–ª–∏ —Å center –Ω–∞ flex-start */
    justify-content: center;
    padding-top: 2rem; /* –î–æ–±–∞–≤–∏–ª–∏ –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
}

        .create-news-content {
            background: var(--color-surface);
            border: 1px solid rgba(255, 23, 68, 0.3);
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            padding: 2rem;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 40px;
            height: 40px;
            background: rgba(255, 23, 68, 0.1);
            border: 1px solid rgba(255, 23, 68, 0.3);
            border-radius: 50%;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 23, 68, 0.3);
            transform: rotate(90deg);
        }

        .create-news-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            color: var(--color-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 23, 68, 0.3);
            border-radius: 10px;
            padding: 0.8rem;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-group textarea {
            min-height: 200px;
            resize: vertical;
        }

        .image-upload-area {
            border: 2px dashed rgba(255, 23, 68, 0.3);
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .image-upload-area:hover {
            border-color: var(--color-primary);
            background: rgba(255, 23, 68, 0.05);
        }

        .image-upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
        }

        .image-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .image-preview-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            background: rgba(255, 23, 68, 0.9);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--color-primary), #ff4569);
            border: none;
            border-radius: 10px;
            padding: 1rem 2rem;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 23, 68, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .news-item {
            background: var(--color-surface);
            border: 1px solid rgba(255, 23, 68, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .news-item:hover {
            border-color: rgba(255, 23, 68, 0.5);
            transform: translateY(-2px);
        }

        .news-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .news-author {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .news-author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--color-primary);
        }

        .news-author-info {
            display: flex;
            flex-direction: column;
        }

        .news-author-name {
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .news-date {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }

        .news-tag {
            background: linear-gradient(135deg, var(--color-primary), #ff4569);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .news-title {
            color: white;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .news-content {
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .news-images {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .news-image {
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: var(--transition);
        }

        .news-image:hover {
            transform: scale(1.05);
        }

        .news-image img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .news-actions {
            display: flex;
            gap: 2rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 23, 68, 0.2);
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .action-btn:hover {
            color: var(--color-primary);
        }

        .action-btn.liked {
            color: var(--color-primary);
        }

        .action-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .comments-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 23, 68, 0.2);
        }

        .comment-input-area {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .comment-input-area textarea {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 23, 68, 0.3);
            border-radius: 10px;
            padding: 0.8rem;
            color: white;
            font-family: inherit;
            resize: none;
            height: 60px;
        }

        .comment-input-area textarea:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .comment-submit-btn {
            background: linear-gradient(135deg, var(--color-primary), #ff4569);
            border: none;
            border-radius: 10px;
            padding: 0 1.5rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .comment-submit-btn:hover {
            transform: translateY(-2px);
        }

        .comment-item {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .comment-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--color-primary);
        }

        .comment-content {
            flex: 1;
        }

        .comment-author {
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .comment-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .comment-text .mention {
            color: var(--color-primary);
            font-weight: 600;
            cursor: pointer;
        }

        .comment-text .mention:hover {
            text-decoration: underline;
        }

        .comment-date {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.75rem;
            margin-top: 0.3rem;
        }

        .delete-news-btn {
            background: rgba(255, 23, 68, 0.2);
            border: 1px solid var(--color-primary);
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .delete-news-btn:hover {
            background: var(--color-primary);
        }

        .loading-spinner {
            text-align: center;
            padding: 2rem;
            color: var(--color-primary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 23, 68, 0.3);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .image-fullscreen-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 9999;
    align-items: center;
    justify-content: center;
    cursor: zoom-out;
}

.image-fullscreen-overlay.active {
    display: flex;
}

.image-fullscreen-overlay img {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    border-radius: 10px;
}

.news-image {
    cursor: zoom-in;
}

        .notification-bell {
    position: relative;
    width: 40px;
    height: 40px;
    background: rgba(255, 23, 68, 0.1);
    border: 1px solid rgba(255, 23, 68, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
}

.notification-bell:hover {
    background: rgba(255, 23, 68, 0.2);
    transform: translateY(-2px);
}

.notification-bell svg {
    width: 20px;
    height: 20px;
    fill: white;
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--color-primary);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    font-weight: 600;
    border: 2px solid var(--color-bg);
}

.notifications-dropdown {
    display: none;
    position: absolute;
    top: 60px;
    right: 0;
    width: 350px;
    max-height: 500px;
    background: var(--color-surface);
    border: 1px solid rgba(255, 23, 68, 0.3);
    border-radius: 15px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.notifications-dropdown.active {
    display: block;
}

.notifications-header {
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 23, 68, 0.2);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.notifications-header h3 {
    color: white;
    font-size: 1.1rem;
    margin: 0;
}

.mark-all-read {
    color: var(--color-primary);
    font-size: 0.85rem;
    cursor: pointer;
    background: none;
    border: none;
    transition: var(--transition);
}

.mark-all-read:hover {
    text-decoration: underline;
}

.notification-item {
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 23, 68, 0.1);
    cursor: pointer;
    transition: var(--transition);
}

.notification-item:hover {
    background: rgba(255, 23, 68, 0.05);
}

.notification-item.unread {
    background: rgba(255, 23, 68, 0.1);
}

.notification-item.unread::before {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    background: var(--color-primary);
    border-radius: 50%;
    margin-right: 0.5rem;
}

.notification-title {
    color: white;
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
}

.notification-message {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.85rem;
    margin-bottom: 0.3rem;
}

.notification-time {
    color: rgba(255, 255, 255, 0.4);
    font-size: 0.75rem;
}

.no-notifications {
    padding: 2rem;
    text-align: center;
    color: rgba(255, 255, 255, 0.5);
}
        
    </style>
</head>

<body>
    <div id="page-loader">
        <div class="loader-content">
            <div class="loader-text">–ñ–¥–∞—Ç—å. –ò–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞.</div>
        </div>
    </div>

    <header class="topbar">
        <div class="container topbar-inner">
            <div class="brand">
                <a href="../homepage">
                    <div class="logo-mark"
                        style="background: url('../assets/images/Falcone.png') no-repeat center/cover;">
                    </div>
                    <span class="brand-title">Dom Falcone</span>
                </a>
            </div>
            <nav class="nav">
                <a href="../about">–û –¥–æ–º–µ</a>
                <a href="../history">–ò—Å—Ç–æ—Ä–∏—è</a>
                <a href="../enemies">–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫–∏</a>
                <a href="../news" class="active">–ù–æ–≤–æ—Å—Ç–∏</a>
            </nav>
            <div class="auth-action" id="auth-action">
                <a href="../login" class="btn-login">–í–æ–π—Ç–∏</a>
            </div>
            <div class="user-menu" id="user-menu" style="display: none;">
    <div style="position: relative;">
        <div class="notification-bell" id="notification-bell">
            <svg viewBox="0 0 24 24"><path d="M12,22A2,2 0 0,1 10,20H14A2,2 0 0,1 12,22M18,16V11C18,7.93 16.37,5.36 13.5,4.68V4A1.5,1.5 0 0,0 12,2.5A1.5,1.5 0 0,0 10.5,4V4.68C7.63,5.36 6,7.92 6,11V16L4,18V19H20V18L18,16M12,6A5,5 0 0,1 17,11V17H7V11A5,5 0 0,1 12,6Z"/></svg>
            <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
        </div>
        <div class="notifications-dropdown" id="notifications-dropdown">
            <div class="notifications-header">
                <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                <button class="mark-all-read" id="mark-all-read">–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ</button>
            </div>
            <div id="notifications-list"></div>
        </div>
    </div>
    <a href="../dashboard" class="user-profile-info">
        <img src="" alt="Avatar" id="header-avatar" class="header-avatar">
        <div class="user-details">
            <span class="user-display-name" id="header-display-name">User</span>
            <div class="user-points-badge">
                <span>‚≠ê</span>
                <span id="header-points">0</span>
            </div>
        </div>
    </a>
</div>
        </div>
    </header>

    <div class="page-header"
        style="background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.4)), url('../assets/images/news-background.jpg') center/cover no-repeat; background-position: center 55%;">
        <div class="container">
            <h1>–•—Ä–æ–Ω–∏–∫–∏ –î–æ–º–∞</h1>
            <p>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Å—Ç–∏ —Å –ø–æ–ª–µ–π —Å—Ä–∞–∂–µ–Ω–∏–π –∏ –∂–∏–∑–Ω–∏ –°–µ–º—å–∏</p>
        </div>
    </div>

    <main class="content-section">
        <div class="container">
            <div id="news-container">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </main>

    <button class="admin-create-btn" id="admin-create-btn" style="display: none;"></button>

    <div class="create-news-modal" id="create-news-modal">
        <div class="create-news-content">
            <button class="modal-close" id="modal-close">&times;</button>
            <h2 style="color: white; margin-bottom: 1.5rem;">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å</h2>
            <form class="create-news-form" id="create-news-form">
                <div class="form-group">
                    <label>–¢–µ–≥</label>
                    <select id="news-tag" required>
                        <option value="–í–∞–∂–Ω–æ–µ">–í–∞–∂–Ω–æ–µ</option>
                        <option value="–ù–æ–≤–æ—Å—Ç–∏">–ù–æ–≤–æ—Å—Ç–∏</option>
                        <option value="–û–±—ä—è–≤–ª–µ–Ω–∏–µ">–û–±—ä—è–≤–ª–µ–Ω–∏–µ</option>
                        <option value="–°–æ–±—ã—Ç–∏—è">–°–æ–±—ã—Ç–∏—è</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="news-title" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–æ–≤–æ—Å—Ç–∏" required>
                </div>
                <div class="form-group">
                    <label>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                    <textarea id="news-content" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏..." required></textarea>
                </div>
                <div class="form-group">
                    <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                    <div class="image-upload-area" id="image-upload-area">
                        <input type="file" id="image-input" accept="image/*" multiple>
                        <div class="upload-icon">üì∏</div>
                        <p style="color: rgba(255, 255, 255, 0.6);">–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
                    </div>
                    <div class="image-preview-grid" id="image-preview-grid"></div>
                </div>
                <button type="submit" class="submit-btn">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <div class="container">
            <small>¬© –î–æ–º –§–∞–ª—å–∫–æ–Ω–µ ‚Äî 2025. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. –ü—Ä—è–º —Ä–µ–∞–ª—å–Ω–æ –∑–∞—â–∏—â–µ–Ω—ã.</small>
            <div class="site-version"></div>
            <div class="footer-links">
                <a href="../privacy">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
                <a href="../agreement">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</a>
                <a href="../imprint">–°–≤–µ–¥–µ–Ω–∏—è –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ —Å–∞–π—Ç–∞</a>
                <a href="../hymn">–ì–µ—Ä–± –∏ –ì–∏–º–Ω</a>
            </div>
        </div>
    </footer>

    <a href="../contact" class="floating-contact-btn">
        <img src="../assets/images/phone-icon.png" alt="Contact">
        <span class="btn-text">–°–≤—è–∑–∞—Ç—å—Å—è —Å –î–æ–º–æ–º</span>
    </a>

    <script>
        const API_BASE = "https://dom-falcone-auth.dom-falcone-official.workers.dev/api";
        const token = localStorage.getItem('auth_token');
        let currentUser = null;
        let uploadedImages = [];

        async function loadUserHeader() {
    if (!token) {
        document.getElementById('auth-action').style.display = 'block';
        document.getElementById('user-menu').style.display = 'none';
        return;
    }

    try {
        const res = await fetch(API_BASE + "/me", {
            headers: { "Authorization": "Bearer " + token }
        });

        if (res.ok) {
            currentUser = await res.json();
            document.getElementById('auth-action').style.display = 'none';
            document.getElementById('user-menu').style.display = 'flex';
            document.getElementById('header-display-name').textContent = currentUser.display_name || currentUser.email.split('@')[0];
            document.getElementById('header-points').textContent = currentUser.points || 0;

            const avatar = document.getElementById('header-avatar');
            if (currentUser.avatar_url) {
                avatar.src = currentUser.avatar_url;
            } else {
                const initial = currentUser.display_name ? currentUser.display_name[0].toUpperCase() : 'U';
                avatar.src = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40'%3E%3Crect fill='%23ff1744' width='40' height='40'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' fill='white' font-size='20' font-family='Arial'%3E${initial}%3C/text%3E%3C/svg%3E`;
            }

            if (currentUser.role === 'admin') {
                document.getElementById('admin-create-btn').style.display = 'flex';
            }

            // –î–û–ë–ê–í–¨–¢–ï –≠–¢–ò 4 –°–¢–†–û–ö–ò –°–Æ–î–ê:
            loadNotifications();
            if (notificationsInterval) clearInterval(notificationsInterval);
            notificationsInterval = setInterval(loadNotifications, 30000);
            
        } else {
            localStorage.removeItem('auth_token');
            document.getElementById('auth-action').style.display = 'block';
            document.getElementById('user-menu').style.display = 'none';
        }
    } catch (err) {
        console.error('Error:', err);
    }
}

        async function loadNews() {
            try {
                const res = await fetch(API_BASE + "/news");
                const data = await res.json();
                const container = document.getElementById('news-container');
                container.innerHTML = '';

                if (data.news && data.news.length > 0) {
                    data.news.forEach(news => {
                        container.appendChild(createNewsCard(news));
                    });
                } else {
                    container.innerHTML = '<p style="text-align: center; color: rgba(255, 255, 255, 0.5);">–ù–æ–≤–æ—Å—Ç–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
                }
            } catch (err) {
        console.error('Error:', err);
        const container = document.getElementById('news-container');
        container.innerHTML = '<p style="text-align: center; color: rgba(255, 255, 255, 0.5);">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ—Å—Ç–µ–π</p>';
    } finally {
        // –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫
        document.getElementById('page-loader').style.display = 'none';
    }
}

        function createNewsCard(news) {
            const card = document.createElement('div');
            card.className = 'news-item';
            const date = new Date(news.created_at).toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });
            const canDelete = currentUser && currentUser.role === 'admin';

            card.innerHTML = `
                <div class="news-header">
                    <div class="news-author">
                        <img src="${news.author_avatar || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\'%3E%3Crect fill=\'%23ff1744\' width=\'40\' height=\'40\'/%3E%3C/svg%3E'}" class="news-author-avatar">
                        <div class="news-author-info">
                            <div class="news-author-name">${news.author_name}</div>
                            <div class="news-date">${date}</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="news-tag">${news.tag}</div>
                        ${canDelete ? `<button class="delete-news-btn" onclick="deleteNews(${news.id})">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                    </div>
                </div>
                <h2 class="news-title">${news.title}</h2>
                <div class="news-content">${news.content.replace(/\n/g, '<br>')}</div>
                ${news.images.length > 0 ? `<div class="news-images">${news.images.map((img, idx) => `<div class="news-image" onclick="openImageFullscreen('${img}')"><img src="${img}"></div>`).join('')}</div>` : ''}
                <div class="news-actions">
                    <button class="action-btn ${news.user_liked ? 'liked' : ''}" onclick="toggleLike(${news.id}, this)">
                        <svg viewBox="0 0 24 24"><path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"/></svg>
                        <span>${news.likes_count}</span>
                    </button>
                    <button class="action-btn" onclick="toggleComments(${news.id})">
                        <svg viewBox="0 0 24 24"><path d="M9,22A1,1 0 0,1 8,21V18H4A2,2 0 0,1 2,16V4C2,2.89 2.9,2 4,2H20A2,2 0 0,1 22,4V16A2,2 0 0,1 20,18H13.9L10.2,21.71C10,21.9 9.75,22 9.5,22H9Z"/></svg>
                        <span>${news.comments_count}</span>
                    </button>
                </div>
                <div class="comments-section" id="comments-${news.id}" style="display: none;"></div>
            `;
            return card;
        }

        async function toggleLike(newsId, button) {
            if (!token) {
                alert('–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏');
                return;
            }
            try {
                const res = await fetch(API_BASE + "/news/like", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ newsId })
                });
                if (res.ok) {
                    const data = await res.json();
                    button.classList.toggle('liked', data.liked);
                    const countSpan = button.querySelector('span');
                    countSpan.textContent = data.liked ? parseInt(countSpan.textContent) + 1 : parseInt(countSpan.textContent) - 1;
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        async function toggleComments(newsId) {
            const section = document.getElementById(`comments-${newsId}`);
            if (section.style.display === 'none') {
                section.style.display = 'block';
                await loadComments(newsId);
            } else {
                section.style.display = 'none';
            }
        }

        async function loadComments(newsId) {
            try {
                const headers = token ? { 'Authorization': 'Bearer ' + token } : {};
                const res = await fetch(API_BASE + `/news/${newsId}`, { headers });
                const data = await res.json();
                const section = document.getElementById(`comments-${newsId}`);
                
                let html = token ? `<div class="comment-input-area"><textarea placeholder="–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." id="comment-input-${newsId}"></textarea><button class="comment-submit-btn" onclick="postComment(${newsId})">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button></div>` : '';

                if (data.comments && data.comments.length > 0) {
                    data.comments.forEach(comment => {
                        const commentDate = new Date(comment.created_at).toLocaleString('ru-RU');
                        const processedContent = comment.content.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
                        html += `<div class="comment-item"><img src="${comment.avatar || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'36\' height=\'36\'%3E%3Crect fill=\'%23ff1744\' width=\'36\' height=\'36\'/%3E%3C/svg%3E'}" class="comment-avatar"><div class="comment-content"><div class="comment-author">${comment.display_name}</div><div class="comment-text">${processedContent}</div><div class="comment-date">${commentDate}</div></div></div>`;
                    });
                }
                section.innerHTML = html;
            } catch (err) {
                console.error('Error:', err);
            }
        }

        async function postComment(newsId) {
            const textarea = document.getElementById(`comment-input-${newsId}`);
            const content = textarea.value.trim();
            if (!content) return;
            try {
                const res = await fetch(API_BASE + "/news/comment", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify({ newsId, content })
                });
                if (res.ok) {
                    textarea.value = '';
                    await loadComments(newsId);
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        async function deleteNews(newsId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –Ω–æ–≤–æ—Å—Ç—å?')) return;
            try {
                const res = await fetch(API_BASE + `/news/${newsId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    alert('–ù–æ–≤–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∞');
                    await loadNews();
                }
            } catch (err) {
                console.error('Error:', err);
            }
        }

        document.getElementById('admin-create-btn')?.addEventListener('click', () => {
            document.getElementById('create-news-modal').classList.add('active');
        });

        document.getElementById('modal-close').addEventListener('click', () => {
            document.getElementById('create-news-modal').classList.remove('active');
        });

        document.getElementById('image-upload-area').addEventListener('click', () => {
            document.getElementById('image-input').click();
        });

        document.getElementById('image-input').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files);
    const previewGrid = document.getElementById('image-preview-grid');
    
    for (const file of files) {
        // –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ - –º–∞–∫—Å–∏–º—É–º 500KB –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const maxSize = 500 * 1024; // 500KB
        if (file.size > maxSize) {
            alert(`–§–∞–π–ª "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${(file.size / 1024).toFixed(0)}KB). –ú–∞–∫—Å–∏–º—É–º ${maxSize / 1024}KB`);
            continue;
        }
        
        // –ú–∞–∫—Å–∏–º—É–º 3 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–≤–º–µ—Å—Ç–æ 5)
        if (uploadedImages.length >= 3) {
            alert('–ú–∞–∫—Å–∏–º—É–º 3 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            break;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        if (!file.type.startsWith('image/')) {
            alert(`–§–∞–π–ª "${file.name}" –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º`);
            continue;
        }
        
        console.log('Processing image:', {
            name: file.name,
            size: file.size,
            type: file.type
        });
        
        // –°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const compressedDataUrl = await compressImage(file, 800, 0.7); // max 800px, –∫–∞—á–µ—Å—Ç–≤–æ 70%
        
        const sizeInKB = (compressedDataUrl.length * 3 / 4 / 1024).toFixed(0);
        console.log('Compressed image size:', sizeInKB + 'KB');
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ –ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è
        if (compressedDataUrl.length > 700 * 1024) { // ~700KB –ø–æ—Å–ª–µ base64
            alert(`–î–∞–∂–µ –ø–æ—Å–ª–µ —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ "${file.name}" —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.`);
            continue;
        }
        
        uploadedImages.push(compressedDataUrl);
        
        const previewItem = document.createElement('div');
        previewItem.className = 'image-preview-item';
        previewItem.innerHTML = `
            <img src="${compressedDataUrl}">
            <button type="button" class="remove-image" onclick="removeImage(${uploadedImages.length - 1})">√ó</button>
        `;
        previewGrid.appendChild(previewItem);
    }
    
    e.target.value = '';
});

        // –§—É–Ω–∫—Ü–∏—è —Å–∂–∞—Ç–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
async function compressImage(file, maxWidth = 800, quality = 0.7) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const img = new Image();
            
            img.onload = () => {
                // –°–æ–∑–¥–∞–µ–º canvas
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –µ—Å–ª–∏ –±–æ–ª—å—à–µ maxWidth
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64 —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∫–∞—á–µ—Å—Ç–≤–æ–º
                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                
                console.log('Image compressed:', {
                    originalSize: file.size,
                    compressedSize: (compressedDataUrl.length * 3 / 4).toFixed(0) + ' bytes',
                    originalDimensions: `${img.width}x${img.height}`,
                    newDimensions: `${width}x${height}`
                });
                
                resolve(compressedDataUrl);
            };
            
            img.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
            img.src = e.target.result;
        };
        
        reader.onerror = () => reject(new Error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞'));
        reader.readAsDataURL(file);
    });
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è removeImage
function removeImage(index) {
    uploadedImages.splice(index, 1);
    const previewGrid = document.getElementById('image-preview-grid');
    previewGrid.innerHTML = '';
    uploadedImages.forEach((img, idx) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'image-preview-item';
        previewItem.innerHTML = `
            <img src="${img}">
            <button type="button" class="remove-image" onclick="removeImage(${idx})">√ó</button>
        `;
        previewGrid.appendChild(previewItem);
    });
}

        // –ó–∞–º–µ–Ω–∏—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –≤ –≤–∞—à–µ–º HTML –Ω–∞ —ç—Ç–æ—Ç –∫–æ–¥

document.getElementById('create-news-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const title = document.getElementById('news-title').value.trim();
    const content = document.getElementById('news-content').value.trim();
    const tag = document.getElementById('news-tag').value;
    
    console.log('=== SUBMIT FORM START ===');
    console.log('Form data:', {
        title: title.substring(0, 50) + '...',
        contentLength: content.length,
        tag: tag,
        imagesCount: uploadedImages.length
    });
    
    if (!title || !content) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
    }
    
    const submitBtn = e.target.querySelector('.submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = '–ü—É–±–ª–∏–∫–∞—Ü–∏—è...';
    
    try {
        const payload = {
            title: title,
            content: content,
            tag: tag,
            images: uploadedImages
        };
        
        console.log('Preparing request:', {
            url: API_BASE + "/news",
            method: 'POST',
            hasToken: !!token,
            tokenPreview: token ? token.substring(0, 20) + '...' : 'none',
            payloadSize: JSON.stringify(payload).length
        });
        
        console.log('Sending request...');
        const res = await fetch(API_BASE + "/news", {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify(payload)
        });
        
        console.log('Response received:', {
            status: res.status,
            statusText: res.statusText,
            ok: res.ok,
            headers: Object.fromEntries(res.headers.entries())
        });
        
        const responseText = await res.text();
        console.log('Response text:', responseText);
        
        let responseData;
        try {
            responseData = JSON.parse(responseText);
            console.log('Response data parsed:', responseData);
        } catch (parseErr) {
            console.error('Failed to parse response as JSON:', parseErr);
            throw new Error('–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç: ' + responseText.substring(0, 100));
        }
        
        if (res.ok) {
            console.log('=== SUBMIT SUCCESS ===');
            alert('–ù–æ–≤–æ—Å—Ç—å –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞!');
            document.getElementById('create-news-modal').classList.remove('active');
            document.getElementById('create-news-form').reset();
            uploadedImages = [];
            document.getElementById('image-preview-grid').innerHTML = '';
            await loadNews();
        } else {
            console.error('=== SUBMIT FAILED ===');
            console.error('Error response:', responseData);
            
            let errorMsg = '–û—à–∏–±–∫–∞: ' + (responseData.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            if (responseData.details) {
                errorMsg += '\n–î–µ—Ç–∞–ª–∏: ' + responseData.details;
            }
            if (responseData.type) {
                errorMsg += '\n–¢–∏–ø: ' + responseData.type;
            }
            
            alert(errorMsg);
        }
    } catch (err) {
        console.error('=== SUBMIT EXCEPTION ===');
        console.error('Error:', err);
        console.error('Error type:', err.constructor.name);
        console.error('Error message:', err.message);
        console.error('Error stack:', err.stack);
        
        alert('–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏: ' + err.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –Ω–æ–≤–æ—Å—Ç—å';
        console.log('=== SUBMIT FORM END ===');
    }
});

        document.addEventListener('DOMContentLoaded', async () => {
    try {
        await loadUserHeader();
        await loadNews();
    } catch (err) {
        console.error('Init error:', err);
    } finally {
        document.getElementById('page-loader').style.display = 'none';
    }
});

        // –°–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑—á–∏–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
window.addEventListener('load', () => {
    document.getElementById('page-loader').style.display = 'none';
    
});

// –û—Ç–∫—Ä—ã—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
function openImageFullscreen(imageSrc) {
    let overlay = document.getElementById('image-fullscreen-overlay');
    
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'image-fullscreen-overlay';
        overlay.className = 'image-fullscreen-overlay';
        overlay.onclick = closeImageFullscreen;
        document.body.appendChild(overlay);
    }
    
    overlay.innerHTML = `<img src="${imageSrc}" onclick="event.stopPropagation()">`;
    overlay.classList.add('active');
    document.body.style.overflow = 'hidden';
}

// –ó–∞–∫—Ä—ã—Ç—å –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
function closeImageFullscreen() {
    const overlay = document.getElementById('image-fullscreen-overlay');
    if (overlay) {
        overlay.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∞–≤–∏—à–µ Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeImageFullscreen();
    }
});

        let notificationsInterval;

// –ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
async function loadNotifications() {
    if (!token) return;
    
    try {
        const res = await fetch(API_BASE + "/notifications", {
            headers: { "Authorization": "Bearer " + token }
        });
        
        if (res.ok) {
            const data = await res.json();
            updateNotificationBadge(data.unread_count);
            renderNotifications(data.notifications);
        }
    } catch (err) {
        console.error('Load notifications error:', err);
    }
}

// –û–±–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function updateNotificationBadge(count) {
    const badge = document.getElementById('notification-badge');
    if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'flex';
    } else {
        badge.style.display = 'none';
    }
}

// –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function renderNotifications(notifications) {
    const list = document.getElementById('notifications-list');
    
    if (!notifications || notifications.length === 0) {
        list.innerHTML = '<div class="no-notifications">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
        return;
    }
    
    list.innerHTML = notifications.map(notif => {
        const time = formatNotificationTime(notif.created_at);
        const unreadClass = notif.is_read === 0 ? 'unread' : '';
        
        return `
            <div class="notification-item ${unreadClass}" onclick="handleNotificationClick(${notif.id}, ${notif.related_id}, '${notif.type}')">
                <div class="notification-title">${notif.title}</div>
                <div class="notification-message">${notif.message}</div>
                <div class="notification-time">${time}</div>
            </div>
        `;
    }).join('');
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Ä–µ–º—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function formatNotificationTime(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
    if (minutes < 60) return `${minutes} –º–∏–Ω –Ω–∞–∑–∞–¥`;
    if (hours < 24) return `${hours} —á –Ω–∞–∑–∞–¥`;
    if (days < 7) return `${days} –¥ –Ω–∞–∑–∞–¥`;
    
    return new Date(timestamp).toLocaleDateString('ru-RU');
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é
async function handleNotificationClick(notificationId, relatedId, type) {
    try {
        // –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
        await fetch(API_BASE + "/notifications/read", {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token 
            },
            body: JSON.stringify({ notificationId })
        });
        
        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        await loadNotifications();
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–≤—è–∑–∞–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É
        if (relatedId && type.includes('news')) {
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–æ–≤–æ—Å—Ç–∏ (–µ—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–æ–≤–æ—Å—Ç–µ–π)
            document.getElementById('notifications-dropdown').classList.remove('active');
        }
    } catch (err) {
        console.error('Handle notification click error:', err);
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
document.getElementById('notification-bell')?.addEventListener('click', (e) => {
    e.stopPropagation();
    const dropdown = document.getElementById('notifications-dropdown');
    dropdown.classList.toggle('active');
    if (dropdown.classList.contains('active')) {
        loadNotifications();
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('notifications-dropdown');
    const bell = document.getElementById('notification-bell');
    if (dropdown && !dropdown.contains(e.target) && !bell.contains(e.target)) {
        dropdown.classList.remove('active');
    }
});

// –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
document.getElementById('mark-all-read')?.addEventListener('click', async () => {
    try {
        await fetch(API_BASE + "/notifications/read-all", {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        await loadNotifications();
    } catch (err) {
        console.error('Mark all read error:', err);
    }
});
        
    </script>
</body>

</html>
